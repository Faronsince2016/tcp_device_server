# 动作执行客户端功能说明

## 功能概述

本项目新增了动作执行客户端管理功能，实现了以下特性：

1. **心跳检测增强**：所有连接到服务器的客户端发送任何信息都被认为是心跳信息
2. **动作执行客户端标记**：当客户端发送以'A'开头的消息时，自动标记为动作执行客户端
3. **Result消息路由**：从Redis接收到的result消息专门发送给对应的动作执行客户端
4. **消息格式规范**：支持特定的result消息格式解析和转发

## 消息格式

### 动作执行客户端标记消息
```
A[客户端ID]\r\n
```
例如：`A5\r\n` 表示客户端ID为5的动作执行客户端

### Result消息格式
```
B\r\n[坐标个数] [目标客户端ID] [预留标志1] [预留标志2] [x坐标] [y坐标] [角度]\r\n
```
例如：`B\r\n1 5 0 0 100.5 200.3 45.0\r\n`

## 文件说明

### 1. `tcp_device_server.py` (已修改)
主TCP服务器，新增功能：
- 动作执行客户端管理
- Result消息解析和路由
- 增强的状态监控

### 2. `action_client_simulator.py` (新建)
动作执行客户端模拟器：
- 每2秒自动发送心跳消息 `A[ID]\r\n`
- 接收并处理服务器发来的result消息
- 模拟执行动作指令
- 支持断线重连

### 3. `test_result_sender.py` (新建)
Result消息测试工具：
- 向Redis发送标准格式的result消息
- 支持测试序列和交互模式
- 用于测试整个消息流程

## 使用方法

### 启动TCP服务器
```bash
python tcp_device_server.py
```

### 启动动作执行客户端模拟器
```bash
# 默认连接localhost:8889，客户端ID为5
python action_client_simulator.py

# 自定义参数
python action_client_simulator.py --host 192.168.1.100 --port 8889 --client-id 7
```

### 发送测试消息
```bash
# 发送测试序列
python test_result_sender.py --mode test

# 交互模式手动输入
python test_result_sender.py --mode interactive
```

## 工作流程

1. **客户端连接**：动作执行客户端连接到TCP服务器
2. **客户端标记**：发送`A[ID]\r\n`消息，被服务器标记为动作执行客户端
3. **心跳维持**：每2秒自动发送心跳消息保持连接
4. **Result接收**：服务器从Redis接收result消息
5. **消息解析**：服务器解析result消息格式
6. **目标路由**：根据目标客户端ID将消息发送给相应的动作执行客户端
7. **动作执行**：客户端接收消息并模拟执行相应动作

## 日志文件

- `device_server.log`: 服务器日志
- `action_client_[ID].log`: 动作执行客户端日志
- `result_sender.log`: 测试发送器日志

## 状态监控

服务器每30秒会在日志中输出：
- 在线设备数量和列表
- 动作执行客户端数量和列表

## 容错机制

1. **客户端超时**：普通设备1秒内未收到心跳则断开连接，**动作执行客户端不受超时限制**
2. **自动重连**：客户端支持断线自动重连
3. **备用路由**：目标客户端不可用时自动发送给其他可用的动作执行客户端
4. **消息验证**：严格验证result消息格式

## 重要特性

### 动作执行客户端特殊处理
- **无超时限制**：动作执行客户端标记后，服务器不会因为心跳超时而主动断开连接
- **持久连接**：即使暂时停止发送心跳，连接也会保持，适合处理长时间动作任务
- **灵活心跳**：虽然客户端每2秒发送心跳，但服务器端不强制要求严格的心跳时间
- **手动断开**：只有客户端主动断开或网络异常时连接才会中断

## 测试验证

1. 启动服务器和Redis
2. 启动一个或多个动作执行客户端
3. 使用测试工具发送result消息
4. 观察客户端是否正确接收并执行动作

## 示例测试流程

```bash
# 终端1：启动服务器
python tcp_device_server.py

# 终端2：启动客户端ID为5
python action_client_simulator.py --client-id 5

# 终端3：启动客户端ID为6  
python action_client_simulator.py --client-id 6

# 终端4：发送测试消息
python test_result_sender.py --mode test
```

观察各个终端的日志输出，验证消息路由是否正确。 